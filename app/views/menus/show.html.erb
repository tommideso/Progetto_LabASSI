<!-- Immagini -->
<div class="flex gap-1">
  <% if @menu.images.attached? %>
      <% @menu.images.each do |image| %>
        <%= image_tag(image, class: "h-72") %>
        <br/>
      <% end %>
  <% end %>
</div>
<div class="w-full flex justify-between items-center">
  <h1><%= @menu.titolo %></h1>
  <div id="favorite-button">
  <% if user_signed_in? && current_user.client? %>
    <%= button_to favorite_text, favorites_menu_path, method: :put %>
  <% end %>
</div>
</div>

<!-- Preferiti -->


<p><strong>Chef:</strong> <%= link_to @menu.chef.user.nome, profile_path(@menu.chef.user) %></p>
<%= render partial: "profiles/avatar", locals: {user: @menu.chef.user} %>
<p><strong>Descrizione:</strong> <%= raw @menu.descrizione %></p>

<h2>Piatti</h2>

<% if @menu.dishes.any? %>
  <div class="flex flex-col gap-4">
      <% @menu.dishes.sort_by { |piatto| ['Antipasto', 'Primo', 'Secondo', 'Dolce'].index(piatto.tipo_portata) }.each do |piatto| %>
        <div>
          <p><strong>Nome:</strong> <%= piatto.nome %></p>
          <p><strong>Ingredienti:</strong> <%= piatto.ingredienti %></p>
          <p><strong>Tipo portata:</strong> <%= piatto.tipo_portata %></p>
        </div>
      <% end %>
  </div>
<% else %>
  <p>Non ci sono piatti associati a questo menu.</p>
<% end %>

<p><strong>Prezzo per Persona:</strong> <%= number_to_currency(@menu.prezzo_persona, unit: "€") %></p>

<p><strong>Numero Minimo di Persone:</strong> <%= @menu.min_persone %></p>

<p><strong>Numero Massimo di Persone:</strong> <%= @menu.max_persone %></p>

<p><strong>Tipo di Cucina:</strong> <%= @menu.tipo_cucina %></p>

<p><strong>Allergeni:</strong>
  <% if @menu.allergeni.present? %>
    <ul class="m-0">
      <% @menu.allergeni.each do |allergene, presente| %>
        <li><%= "#{allergene.capitalize}: #{presente == 'true' ? 'Sì' : 'No'}" %></li>
      <% end %>
    </ul>
  <% else %>
    <p>Nessun allergene registrato.</p>
  <% end %>
</p>

<p><strong>Preferenze Alimentari:</strong>
  <% if @menu.preferenze_alimentari.present? %>
    <ul>
      <% @menu.preferenze_alimentari.each do |preferenza, presente| %>
        <li><%= "#{preferenza.capitalize}: #{presente == 'true' ? 'Sì' : 'No'}" %></li>
      <% end %>
    </ul>
  <% else %>
    <p>Nessuna preferenza alimentare registrata.</p>
  <% end %>
</p>

<p><strong>Adattabile per allergeni:</strong>
  <% if @menu.adattabile.present? && @menu.adattabile["allergeni"].present? %>
    <ul>
      <% @menu.adattabile["allergeni"].each do |adattamento, presente| %>
        <li><%= "#{adattamento.capitalize}: #{presente == 'true' ? 'Sì' : 'No'}" %></li>
      <% end %>
    </ul>
  <% else %>
    <p> Nessun adattamento per allergeni.</p>
  <% end %>
</p>

<p><strong>Adattabile per preferenze alimentari:</strong>
  <% if @menu.adattabile.present? && @menu.adattabile["preferenze"].present? %>
    <ul>
      <% @menu.adattabile["preferenze"].each do |adattamento, presente| %>
        <li><%= "#{adattamento.capitalize}: #{presente == 'true' ? 'Sì' : 'No'}" %></li>
      <% end %>
    </ul>
  <% else %>
    <p>Nessun adattamento per preferenze alimentari.</p>
  <% end %>
</p>

<p><strong>Extra:</strong>
  <% if @menu.extra.present? %>
    <ul>
      <% @menu.extra.each do |extra, valore| %>
        <li><%= "#{extra.capitalize}: #{valore.nil? ? "No" : valore }€ a persona" %></li>
      <% end %>
    </ul>
  <% else %>
    <p>Nessun extra registrato.</p>
  <% end %>
</p>

<p><strong>Prezzo Extra:</strong> <%= number_to_currency(@menu.prezzo_extra, unit: "€") %></p>

<p><strong>Disattivato:</strong> <%= @menu.disattivato ? 'Sì' : 'No' %></p>

<% if user_signed_in? %>

  <!-- Pulsante di disattivazione -->
  <p><strong>Stato del menu:</strong>
    <% if @menu.disattivato %>
      <% if @menu.disattivato_da == 'chef' %>
        <span>Disattivato dallo Chef</span>
        <% if current_user.admin? %>
          <p>L'admin non può modificare questo menu disattivato dallo chef.</p>
        <% end %>
      <% elsif @menu.disattivato_da == 'admin' %>
        <span>Disattivato dall'Admin</span>
        <% if current_user.chef? %>
          <p>Lo chef non può modificare questo menu disattivato dall'admin.</p>
        <% end %>
      <% end %>
    <% else %>
      <!-- Menu attivo -->
      <span>Attivo</span>
      <% if current_user.chef? || current_user.admin? %>
        <%= button_to "Disattiva Menu", disattiva_menu_path(@menu), method: :post, data: { turbo: false } %>
      <% end %>
    <% end %>
  </p>

  <!-- Pulsante di riattivazione -->
  <% if @menu.disattivato && ((current_user.admin? && @menu.disattivato_da != 'chef') || (current_user.chef? && @menu.disattivato_da != 'admin')) %>
    <%= button_to "Riattiva Menu", riattiva_menu_path(@menu), method: :post, data: { turbo: false } %>
  <% end %>


  <% if current_user.chef? %>
    <h3> <%= link_to "Modifica il menu", edit_menu_path %> </h3>
  <% end %>

  <% if current_user.client? %>
    <%= form_with model: Reservation, url: reservations_path, data: {
      controller: "flatpickr",
      flatpickr_disabled_dates_value: @disabled_dates.to_json
    }, local: true do |f| %>
      

      <%= f.hidden_field :menu_id, value: @menu.id %> 
      <%# Num Persone, TipoPasto, Data, Indirizzo di consegna %>
      <div>
        <%= f.label :indirizzo_consegna %>
        <%= f.text_field :indirizzo_consegna, class: "form-control", value: current_user.client.indirizzo %>
      </div>
      <div>
        <%= f.label :num_persone %>
        <%= f.number_field :num_persone, class: "form-control", min: @menu.min_persone, max: @menu.max_persone, id: "num_persone" %>
      </div>
      <div>
        <%= f.label :tipo_pasto %>
        <%# Prendo i valori del campo tipo_pasto dalla classe Reservation e li mappo in un array di coppie chiave-valore, dove la chiave è il valore del campo e il valore è il campo con la prima lettera maiuscola %>
        <%= f.select :tipo_pasto, Reservation.tipo_pastos.keys.map { |tipo_pasto| [tipo_pasto.humanize, tipo_pasto] }, class: "form-control" %>
      </div>
      <div>
        <%= f.label :data_prenotazione %>
        <%= f.date_field :data_prenotazione, class: "datepicker", min: Date.today, id: "data_prenotazione" %>
      </div>
      <% if @menu.extra["vino"] > 0 %>
        <div>
          <%= f.label :vino, "Vino" %>
          <%= f.hidden_field :vino, value: false %>
          <%= f.check_box :vino, {id: "vino"}, true, false %>
        </div>
      <% else %>
        <%= f.hidden_field :vino, value: false %>
      <% end %>

      <% if @menu.extra["miseenplace"] > 0 %>
        <div>
          <%= f.label :miseenplace, "Mise en place" %>
          <%= f.hidden_field :miseenplace, value: false %>
          <%= f.check_box :miseenplace, {id: "miseenplace"}, true, false %>
        </div>
      <% else %>

        <%= f.hidden_field :miseenplace, value: false %>
      <% end %>
      <div>
        <p> Prezzo totale: <span id="prezzo_totale"></span> </p>
      </div>
      <%# TODO inserire calcolo live del prezzo? %>
      <%= f.submit "Prenota" %>
    <% end %>
  <% end %>
<% end %>


<!-- Recensioni -->
<% if @menu_reviews && @menu_reviews.any? %>
  <% @menu_reviews.each do |review| %>
    <div class="border border-gray-200 p-4 rounded-lg mb-4">
      <p><strong>Valutazione:</strong> <%= review.valutazione %></p>
      <p><strong>Commento:</strong> <%= review.commento %></p>
      <p><strong>Scritta da:</strong> <%= review.reservation.client.user.nome %></p>
      <%# Se admin  %>
      <% if user_signed_in? && current_user.admin? %>
        <p><strong>Prenotazione numero:</strong> <%= link_to review.reservation.id, reservation_path(review.reservation) %></p>
      <% end %>
    </div>
  <% end %>
<% end %>

<script>
document.addEventListener("turbo:load", function() {
  const numPersoneInput = document.getElementById("num_persone");
  const vinoCheckbox = document.getElementById("vino");
  const miseenplaceCheckbox = document.getElementById("miseenplace");
  const prezzoTotaleInput = document.getElementById("prezzo_totale");

  const prezzoMenuPerPersona = <%= @menu.prezzo_persona %>;
  const prezzoVino = <%= @menu.extra["vino"] || 0 %>;
  const prezzoMiseenplace = <%= @menu.extra["miseenplace"] || 0 %>;
  function calcolaPrezzoTotale() {
    const numPersone = parseInt(numPersoneInput.value) || 0;
    const includeVino = vinoCheckbox ? vinoCheckbox.checked : false;
    const includeMiseenplace = miseenplaceCheckbox ? miseenplaceCheckbox.checked : false;

    let prezzoTotale = numPersone * prezzoMenuPerPersona;
    if (includeVino) {
      prezzoTotale += numPersone * prezzoVino;
    }
    if (includeMiseenplace) {
      prezzoTotale += numPersone * prezzoMiseenplace;
    }

    prezzoTotaleInput.textContent = prezzoTotale.toFixed(2) + "€";
  }

  numPersoneInput.addEventListener("input", calcolaPrezzoTotale);
  vinoCheckbox.addEventListener("change", calcolaPrezzoTotale);
  miseenplaceCheckbox.addEventListener("change", calcolaPrezzoTotale);

  // Calcola il prezzo totale iniziale
  calcolaPrezzoTotale();
});

</script>